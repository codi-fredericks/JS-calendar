class Calendar{constructor(e={}){let t={"Default view":"month","Default mobile view":"week","Span events":!0,"Mobile width":900,"Auto color":!0,"Show offset":!1,"24 hour time":!0};return this.config={...t,...e},this.currentDate=new Date,this.view=this.config["Default view"],this.mobile_width=this.config["Mobile width"],this.container=document.createElement("div"),this.container.classList.add("calendar-container"),this.watermarked=!0,this.events=new Map,this.metadata=new Map,this.dateIndex=new Map,this.timestampIndex=new Map,this.evnt_color="",this.init(),this}init(){this.container.innerHTML=`
    <div class="calendar">
        <div class="calendar_toolbar">
            <div style="display:flex;">
                <button id="prev">&lt;</button>
                
                <!-- Title with always-present date picker -->
                <button id="calendar-title-button" style="background-color: transparent;color: black;display: flex; flex-direction: column;">
                    <span id="calendar-title" class="calendar-title"></span>
                    <input type="date" id="calendar-date-picker" class="calendar-date-picker" style="width: 0px; height: 0px; padding: 0px; margin: 0px;">
                </button>

                <button id="next">&gt;</button>
            </div>
            <div>
                <button data-view="month">Month</button>
                <button data-view="week">Week</button>
                <button data-view="day">Day</button>
                <button data-view="agenda">Agenda</button>
            </div>
        </div>
        <div class="calendar_bar_hr" id="calendar-week-head">
            <h2>Monday</h2>
            <h2>Tuesday</h2>
            <h2>Wednesday</h2>
            <h2>Thursday</h2>
            <h2>Friday</h2>
            <h2>Saturday</h2>
            <h2>Sunday</h2>
        </div>
        <div class="calendar_body" id="calendar-body"></div>
    </div>
    ${this.watermarked?`<a href="https://google.com" style="background-color: #146fbf; color: #ffffff; margin-top: 16px; padding: 10px 20px; border-radius: 8px; position: relative; display: inline-block; width: fit-content; text-decoration: none; font-family: Arial, sans-serif; font-size: 16px; font-weight: 500; text-align: center; transition: background-color 0.3s, transform 0.3s;">
        Made with <span style="color: #e25555;">‚ù§</span> by Codi Fredericks
    </a>`:""}`,this.calendarBody=this.container.querySelector("#calendar-body"),this.calendarTitle=this.container.querySelector("#calendar-title"),this.calendarWeekHead=this.container.querySelector("#calendar-week-head"),this.datePicker=this.container.querySelector("#calendar-date-picker"),this.container.querySelector("#prev").addEventListener("click",()=>this.changeDate(-1)),this.container.querySelector("#next").addEventListener("click",()=>this.changeDate(1)),this.container.querySelectorAll("[data-view]").forEach(e=>e.addEventListener("click",e=>this.setView(e.target.dataset.view))),this.container.querySelector("#calendar-title-button").addEventListener("click",()=>{this.datePicker.showPicker()}),this.datePicker.addEventListener("change",e=>{this.currentDate=new Date(e.target.value),this.render()}),setTimeout(()=>{this.container.offsetWidth<this.mobile_width&&(this.view=this.config["Default mobile view"])},0),this.render()}async textToHexColor(e){if(window.crypto&&window.crypto.subtle)try{let t=new TextEncoder,a=t.encode(e),n=await crypto.subtle.digest("SHA-256",a),i=Array.from(new Uint8Array(n)),r=i.map(e=>e.toString(16).padStart(2,"0")).join("");return"#"+r.substring(0,6)}catch(d){return}}getTextColor(e){if(!e)return;let t=parseInt(e.slice(1,3),16),a=parseInt(e.slice(3,5),16),n=parseInt(e.slice(5,7),16);return Math.log(1+(.2126*t+.7152*a+.0722*n))<Math.log(129)?"white":"black"}async add_event(e,t,a=!0){return new Promise(async(n,i)=>{try{let{id:r,title:d,start_timestamp:l,end_timestamp:s,tags:o,all_day:c,color:h,text_color:u}=e;if(!r){console.error("Event must have an ID!");return}!h&&(o&&o.length>0?o[0].color?h=o[0].color:o[0].name?this.config["Auto color"]&&(h=await this.textToHexColor(o[0].name)):this.config["Auto color"]&&(h=await this.textToHexColor(d)):this.config["Auto color"]&&(h=await this.textToHexColor(d))),u||(u=this.getTextColor(h));let p=new Date(1e3*l),g=new Date(1e3*s);this.events.set(r,{id:r,title:d,start_timestamp:l,end_timestamp:s,tags:o,color:h,text_color:u}),t&&this.metadata.set(r,t),!1===this.config["Span events"]?this.indexEventByDate(r,p,p,!0):this.indexEventByDate(r,p,g,c),a&&this.render()}catch(v){i(v)}})}roundDownToHour(e){return new Date(e.getFullYear(),e.getMonth(),e.getDate(),e.getHours(),0,0,0)}indexEventByDate(e,t,a,n){for(let i=new Date(t);i<=a;i.setUTCDate(i.getUTCDate()+1)){if(!1===n&&i.getFullYear()===a.getFullYear()&&i.getMonth()===a.getMonth()&&i.getDate()===a.getDate()&&0===a.getHours()&&0===a.getMinutes()&&0===a.getSeconds())continue;let r=i.toLocaleDateString("en-US");if(this.dateIndex.has(r)||this.dateIndex.set(r,{events:new Set,time:new Map}),this.dateIndex.get(r).events.add(e),!n){let d=this.dateIndex.get(r);for(let l=0;l<24;l++){let s=new Date(i.getFullYear(),i.getMonth(),i.getDate(),l,0,0);if(s<a&&s>=this.roundDownToHour(t)){let o=`${l.toString().padStart(2,"0")}00`;d.time.has(o)||d.time.set(o,new Set),d.time.get(o).add(e)}}}}}get_events_by_date(e){let t=e.toLocaleDateString("en-US");if(!this.dateIndex.has(t))return[];let a=this.dateIndex.get(t);return[...a.events].map(e=>this.events.get(e)).sort((e,t)=>e.start_timestamp-t.start_timestamp)}get_events_by_time(e,t){let a=e.toLocaleDateString("en-US");if(!this.dateIndex.has(a))return[];let n=this.dateIndex.get(a);return n.time.has(t)?[...n.time.get(t)].map(e=>this.events.get(e)).sort((e,t)=>e.start_timestamp-t.start_timestamp):[]}setView(e){this.view=e,this.render()}render(){this.calendarBody.innerHTML="",setTimeout(()=>{this.container.offsetWidth<this.mobile_width?(this.container.setAttribute("mobile",!0),this.calendarWeekHead.innerHTML=`
                <h2>Mon</h2>
                <h2>Tue</h2>
                <h2>Wed</h2>
                <h2>Thu</h2>
                <h2>Fri</h2>
                <h2>Sat</h2>
                <h2>Sun</h2>`):this.calendarWeekHead.innerHTML=`
                <h2>Monday</h2>
                <h2>Tuesday</h2>
                <h2>Wednesday</h2>
                <h2>Thursday</h2>
                <h2>Friday</h2>
                <h2>Saturday</h2>
                <h2>Sunday</h2>`},0),setTimeout(()=>{"month"===this.view?(this.renderMonthView(),this.calendarWeekHead.style.display=""):"week"===this.view?(this.renderWeekView(),this.calendarWeekHead.style.display=""):"day"===this.view?(this.renderDayView(),this.calendarWeekHead.style.display="none"):"agenda"===this.view?(this.renderAgendaView(),this.calendarWeekHead.style.display="none"):alert(`Calendar View Invalid (${this.view})`)},0)}renderMonthView(){this.calendarTitle.textContent=this.currentDate.toLocaleString("default",{month:"long",year:"numeric"});let e=new Date(this.currentDate.getFullYear(),this.currentDate.getMonth(),1),t=1-(0===e.getDay()?6:e.getDay()-1);for(let a=0;a<6;a++){this.currentDate.getFullYear(),this.currentDate.getMonth();let n=document.createElement("div");n.classList.add("calendar_week");let i=document.createElement("div");i.classList.add("calendar_week_events"),n.appendChild(i);let r=[],d=1;for(let l=t;l<t+7;l++){let s=new Date(this.currentDate.getFullYear(),this.currentDate.getMonth(),l),o=this.get_events_by_date(s);o.forEach(e=>{let t=r.find(t=>t.id===e.id);t?t.end+=1:r.push({id:e.id,start:d,end:d+1,text:e.title,color:e.color,text_color:e.text_color})}),d++}r.sort((e,t)=>e.start-t.start);let c={"c-1":1,"c-2":1,"c-3":1,"c-4":1,"c-5":1,"c-6":1,"c-7":1,"c-8":1},h=1;r.forEach(e=>{let t=1;for(let a=e.start;a<e.end;a++)c[a]||(c[a]=0),t=Math.max(t,c[a]);t++;for(let n=e.start;n<e.end;n++)c[n]=t;let r=document.createElement("button");r.classList.add("event"),r.innerText=e.text,r.style.gridArea=`${t} / ${e.start} / ${t+1} / ${e.end}`,r.style.backgroundColor=e.color,r.style.color=e.text_color,r.addEventListener("click",()=>this.open_event(e.id)),i.appendChild(r),h++}),i.parentNode.style.height=`calc(80px + (${this.container.offsetWidth<this.mobile_width?43:24}px*${Math.max(...Object.values(c))}))`;for(let u=0;u<7;u++){let p=document.createElement("div");p.classList.add("calendar_day");let g=new Date(this.currentDate.getFullYear(),this.currentDate.getMonth(),t),v=document.createElement("span");v.classList.add("calendar_stamp"),v.innerText=`${g.getDate()} ${this.config["Show offset"]?`(GMT ${-(new Date().getTimezoneOffset()/60)})`:""}`,p.appendChild(v),g.getMonth()!==this.currentDate.getMonth()&&p.classList.add("other-month"),n.appendChild(p),t++}this.calendarBody.appendChild(n)}}renderWeekView(){let e=this.getStartOfWeek(this.currentDate),t=e.getDate(),a=new Date(e);a.setDate(e.getDate()+6);let n={month:"long",day:"numeric"};this.calendarTitle.textContent=`${e.toLocaleDateString("en-US",n)} - ${a.toLocaleDateString("en-US",n)} ${a.getFullYear()}`;let i=document.createElement("div");i.classList.add("calendar_week");let r=document.createElement("div");r.classList.add("calendar_week_events"),i.appendChild(r);let d=[],l=1;for(let s=t;s<t+7;s++){let o=new Date(this.currentDate.getFullYear(),this.currentDate.getMonth(),s),c=this.get_events_by_date(o);c.forEach(e=>{let t=d.find(t=>t.id===e.id);t?t.end+=1:d.push({id:e.id,start:l,end:l+1,text:e.title,color:e.color,text_color:e.text_color})}),l++}d.sort((e,t)=>e.start-t.start);let h={"c-1":1,"c-2":1,"c-3":1,"c-4":1,"c-5":1,"c-6":1,"c-7":1,"c-8":1},u=1;d.forEach(e=>{let t=1;for(let a=e.start;a<e.end;a++)h[a]||(h[a]=0),t=Math.max(t,h[a]);t++;for(let n=e.start;n<e.end;n++)h[n]=t;let i=document.createElement("button");i.classList.add("event"),i.innerText=e.text,i.style.gridArea=`${t} / ${e.start} / ${t+1} / ${e.end}`,i.style.backgroundColor=e.color,i.style.color=e.text_color,i.addEventListener("click",()=>this.open_event(e.id)),r.appendChild(i),u++}),r.parentNode.style.height=`calc(80px + (${this.container.offsetWidth<this.mobile_width?43:24}px*${Math.max(...Object.values(h))}))`;for(let p=0;p<7;p++){let g=new Date(e);g.setDate(e.getDate()+p);let v=document.createElement("div");v.classList.add("calendar_day");let m=document.createElement("span");m.classList.add("calendar_stamp"),m.innerText=g.getDate(),v.appendChild(m),i.appendChild(v)}this.calendarBody.appendChild(i);let y=document.createElement("div");y.classList.add("calendar_week_time_container");let f=!0;for(let w=t;w<t+7;w++){let $=new Date(this.currentDate.getFullYear(),this.currentDate.getMonth(),w),x=document.createElement("div");x.classList.add("calendar_week_time_container_sub");let _=document.createElement("h2");_.innerText=["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"][$.getDay()],x.appendChild(_);let D=document.createElement("div");D.classList.add("calendar_week_time_container_sub_sub");let b=document.createElement("div");b.classList.add("calendar_week_time_container_events");let k=[],E=1;for(let L=0;L<24;L++){let C=this.get_events_by_time($,`${L.toString().padStart(2,"0")}00`);C.forEach(e=>{let t=k.find(t=>t.id===e.id);t?t.end+=1:k.push({id:e.id,start:E,end:E+1,text:e.title,color:e.color,text_color:e.text_color})}),E++}k.sort((e,t)=>e.start-t.start);let S={};if(k.forEach(e=>{let t=1;for(let a=e.start;a<e.end;a++)S[a]||(S[a]=0),t=Math.max(t,S[a]);t++;for(let n=e.start;n<e.end;n++)S[n]=t;let i=document.createElement("button");i.classList.add("calendar_week_event"),i.innerText=e.text,i.style.gridArea=`${e.start} / ${t-1} / ${e.end} / ${t}`,i.style.backgroundColor=e.color,i.style.color=e.text_color,i.onclick=function(){this.open_event(e.id)},i.addEventListener("click",()=>this.open_event(e.id)),b.appendChild(i)}),f){let T=document.createElement("div");T.classList.add("calendar_week_time_container_stamps");for(let M=0;M<24;M++){let H=document.createElement("div");H.classList.add("calendar_week_time_stamp"),H.innerText=`${this.config["24 hour time"]?`${M}:00`:`${M%12==0?12:M%12}:00 ${M<12?"AM":"PM"}`}`,T.appendChild(H)}D.appendChild(T),f=!1}D.appendChild(b),x.appendChild(D),y.appendChild(x),this.calendarBody.appendChild(y)}}renderDayView(){this.calendarTitle.textContent=this.currentDate.toDateString();let e=document.createElement("div");e.classList.add("calendar_day");let t=document.createElement("span");t.classList.add("calendar_stamp"),t.innerText=this.currentDate.toDateString(),e.appendChild(t);let a=this.get_events_by_date(this.currentDate),n=document.createElement("div");n.classList.add("calendar_day_events");let i=2;console.log(a),a.forEach(e=>{console.log(e);let t=document.createElement("button");t.classList.add("calendar_week_event"),t.innerText=e.title,t.style.gridArea=`${i} / 1 / ${i} / 1`,t.style.backgroundColor=e.color,t.style.color=e.text_color,t.onclick=function(){this.open_event(e.id)},t.addEventListener("click",()=>this.open_event(e.id)),n.appendChild(t),i++}),e.appendChild(n),this.calendarBody.appendChild(e),n.parentNode.style.height=`calc(80px + (${this.container.offsetWidth<this.mobile_width?43:24}px*${i}))`;let r=document.createElement("div");r.classList.add("calendar_week_time_container");let d=!0,l=new Date(this.currentDate.getFullYear(),this.currentDate.getMonth(),this.currentDate.getDate()),s=document.createElement("div");s.classList.add("calendar_week_time_container_sub");let o=document.createElement("div");o.classList.add("calendar_week_time_container_sub_sub");let c=document.createElement("div");c.classList.add("calendar_week_time_container_events");let h=[],u=1;for(let p=0;p<24;p++){let g=this.get_events_by_time(l,`${p.toString().padStart(2,"0")}00`);g.forEach(e=>{let t=h.find(t=>t.id===e.id);t?t.end+=1:h.push({id:e.id,start:u,end:u+1,text:e.title,color:e.color,text_color:e.text_color})}),u++}console.log(h),h.sort((e,t)=>e.start-t.start);let v={};if(h.forEach(e=>{let t=1;for(let a=e.start;a<e.end;a++)v[a]||(v[a]=0),t=Math.max(t,v[a]);t++;for(let n=e.start;n<e.end;n++)v[n]=t;let i=document.createElement("button");i.classList.add("calendar_week_event"),i.innerText=e.text,i.style.gridArea=`${e.start} / ${t-1} / ${e.end} / ${t}`,i.style.backgroundColor=e.color,i.style.color=e.text_color,i.onclick=function(){this.open_event(e.id)},i.addEventListener("click",()=>this.open_event(e.id)),c.appendChild(i)}),d){let m=document.createElement("div");m.classList.add("calendar_day_time_container_stamps");for(let y=0;y<24;y++){let f=document.createElement("div");f.classList.add("calendar_day_time_stamp"),f.innerText=`${this.config["24 hour time"]?`${y}:00`:`${y%12==0?12:y%12}:00 ${y<12?"AM":"PM"}`}`,m.appendChild(f)}o.appendChild(m),d=!1}o.appendChild(c),s.appendChild(o),r.appendChild(s),this.calendarBody.appendChild(r)}renderAgendaView(){this.calendarTitle.textContent=this.currentDate.toLocaleString("default",{month:"long",year:"numeric"});let e=this.currentDate.getFullYear(),t=this.currentDate.getMonth(),a=new Date(e,t+1,0);for(let n=1;n<=a.getDate();n++){let i=new Date(e,t,n),r=this.get_events_by_date(i);if(r.length>0){let d=document.createElement("div");d.classList.add("agenda-date-container");let l=document.createElement("h2");l.innerText=i.toDateString(),d.appendChild(l);let s=document.createElement("div");s.classList.add("agenda-date-events"),r.forEach(e=>{let t=document.createElement("button");t.classList.add("agenda-event"),t.innerText=e.title,t.style.backgroundColor=e.color,t.style.color=e.text_color,t.addEventListener("click",()=>this.open_event(e.id)),s.appendChild(t)}),d.appendChild(s),this.calendarBody.appendChild(d),this.calendarBody.innerHTML+="<hr>"}}}changeDate(e){"month"===this.view?this.currentDate.setMonth(this.currentDate.getMonth()+e):"week"===this.view?this.currentDate.setDate(this.currentDate.getDate()+7*e):"day"===this.view&&this.currentDate.setDate(this.currentDate.getDate()+e),this.render()}getStartOfWeek(e){let t=new Date(e),a=t.getDay(),n=t.getDate()-a+(0===a?-6:1);return t.setDate(n),t}renderTo(e){e.appendChild(this.container)}open_event=function(e){let t=calendar.events.get(e),a=calendar.metadata.get(e);if(!t){console.error("Event not found!");return}let n=document.createElement("div");n.classList.add("event-modal"),n.setAttribute("onclick","close_event()");let i=document.createElement("div");i.classList.add("event-modal-content"),i.addEventListener("click",e=>e.stopPropagation()),i.innerHTML=`
            <div class="event-head">
                <h1>${t.title}</h1>
                <button class="event-close" onclick="close_event()"><h1>&times;</h1></button>
            </div>
            <hr>
            <h2><strong>Start:</strong></h2> <p>${new Date(1e3*t.start_timestamp).toLocaleString()}</p>
            <h2><strong>End:</strong></h2> <p> ${new Date(1e3*t.end_timestamp).toLocaleString()}</p>
            <h2><strong>Tags:</strong></h2>
            <div class="event-tags">
            ${t.tags.map(e=>`<div class="event-tag" style="color:${e.color}; border-color:${e.color}; background-color:${e.color}40;">${e.name}</div>`).join("")}
    
            </div>
            <p>${a?.description||"No description available."}</p>
            <div class="event-fields">
                ${a?.fields?.map(e=>`
                    <div class="event-field">
                        ${e.inline?`
                        <div class="event-inline">
                            <h3>${e.title}</h3>
                            <p>${e.value?e.value:""}</p>
                        </div>`:`<h3>${e.title}</h3>
                        <p>${e.value?e.value:""}</p>`}
                        ${e.custom_html?`<iframe scrolling="no" class="event-custom-html" srcdoc='${e.custom_html}' onload="ResizeEventIframe(this)"></iframe>`:""}
                        
                    </div>
                `).join("")}
            </div>
        `,n.appendChild(i),window.close_event=function(){n.remove()},document.body.appendChild(n)}}window.ResizeEventIframe=function(e){e.contentWindow.document.body&&(e.style.height=e.contentWindow.document.body.scrollHeight+"px")};
